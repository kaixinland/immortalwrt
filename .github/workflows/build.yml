name: Build ImmortalWrt RG-X60 Pro (Overlay 107MB)

on:
  workflow_dispatch:   # 手动触发
  push:                # 可选：推送时自动触发
    branches:
      - master

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout source
        uses: actions/checkout@v3
        with:
          repository: kaixinland/immortalwrt   # 你的 fork 仓库
          ref: v24.10.4                       # 指定版本号

      - name: Cache build
        uses: actions/cache@v3
        with:
          path: |
            dl
            build_dir
          key: ${{ runner.os }}-immortalwrt-${{ github.sha }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential gcc g++ make unzip git \
            libncurses5-dev libncursesw5-dev zlib1g-dev gawk flex gettext \
            wget python3 python3-distutils rsync file libssl-dev \
            libelf-dev ecj fastjar java-propose-classpath

      - name: Update feeds
        run: ./scripts/feeds update -a && ./scripts/feeds install -a

      - name: Prepare config (RG-X60 Pro)
        run: |
          cat > .config <<EOF
          CONFIG_TARGET_mediatek=y
          CONFIG_TARGET_mediatek_mt7986=y
          CONFIG_TARGET_mediatek_mt7986_DEVICE_rg_x60pro=y
          EOF
          make defconfig

      - name: Build firmware
        run: make -j$(nproc)

      - name: Rename firmware files (加 commit SHA 避免冲突)
        run: |
          for f in bin/targets/mediatek/mt7986/rg_x60pro/*.bin; do
            mv "$f" "${f%.bin}-${{ github.sha }}.bin"
          done

      - name: Upload RG-X60 Pro firmware to Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v24.10.4
          name: ImmortalWrt-24.10.4 RG-X60 Pro 固件 (Overlay 107MB)
          files: |
            bin/targets/mediatek/mt7986/rg_x60pro/*.bin
            bin/targets/mediatek/mt7986/rg_x60pro/*.manifest
            bin/targets/mediatek/mt7986/rg_x60pro/*.sha256sum
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
