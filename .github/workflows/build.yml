name: Build ImmortalWrt

on:
  workflow_dispatch:   # 支持手动触发
  push:                # 可选：推送时自动触发
    branches:
      - master

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout source
        uses: actions/checkout@v3
        with:
          repository: immortalwrt/immortalwrt   # 官方仓库
          ref: v24.10.4                         # 固定拉取稳定版

      - name: Show branch and tag info
        run: |
          echo "当前分支/标签信息："
          git describe --tags --always
          git branch -a

      - name: Cache build
        uses: actions/cache@v3
        with:
          path: |
            dl
            build_dir
          key: ${{ runner.os }}-immortalwrt-${{ github.sha }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential gcc g++ make unzip git \
            libncurses5-dev libncursesw5-dev zlib1g-dev gawk flex gettext \
            wget python3 python3-distutils rsync

      - name: Update feeds
        run: ./scripts/feeds update -a && ./scripts/feeds install -a

      - name: Prepare config
        run: |
          cp .config.default .config || true
          make defconfig

      - name: Build firmware
        run: make -j$(nproc)

      - name: Upload firmware to Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v24.10.4
          name: ImmortalWrt-24.10.4 固件
          files: bin/targets/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
